# Домашнее задание к занятию 8.3 «Использование Ansible»

---
## Подготовка к выполнению
Подготовьте в Yandex Cloud три хоста: для clickhouse, для vector и для lighthouse.
Репозиторий LightHouse находится по ссылке.

## Основная часть
 - Допишите playbook: нужно сделать ещё один play, который устанавливает и настраивает LightHouse.
 - При создании tasks рекомендую использовать модули: get_url, template, yum, apt.
 - Tasks должны: скачать статику LightHouse, установить Nginx или любой другой веб-сервер, настроить его конфиг для открытия LightHouse, запустить веб-сервер.
 - Подготовьте свой inventory-файл prod.yml.
 - Запустите ansible-lint site.yml и исправьте ошибки, если они есть.
 - Попробуйте запустить playbook на этом окружении с флагом --check.
 - Запустите playbook на prod.yml окружении с флагом --diff. Убедитесь, что изменения на системе произведены.
 - Повторно запустите playbook с флагом --diff и убедитесь, что playbook идемпотентен.
 - Подготовьте README.md-файл по своему playbook. В нём должно быть описано: что делает playbook, какие у него есть параметры и теги.
 - Готовый playbook выложите в свой репозиторий, поставьте тег 08-ansible-03-yandex на фиксирующий коммит, в ответ предоставьте ссылку на него.

## Как оформить решение задания
Выполненное домашнее задание пришлите в виде ссылки на .md-файл в вашем репозитории.

Инфраструктура разворачивается в YandexCloud с помощью Terraform. Исходники находятся в директории vm. В результате 
развертывания инфраструкры генерируется файл с hosts.yml, который содержится ip адреса групп (Clickhouse, Vector, Lighthouse)  

 - Допишите playbook: нужно сделать ещё один play, который устанавливает и настраивает LightHouse.
 - При создании tasks рекомендую использовать модули: get_url, template, yum, apt.
 - Tasks должны: скачать статику LightHouse, установить Nginx или любой другой веб-сервер, настроить его конфиг для открытия LightHouse, запустить веб-сервер.

````
  - name: Install Lighthouse
    tags: lighthouse
    hosts: lighthouse
    vars_files:
      - ./group_vars/lighthouse/vars.yml
      
#Блок handler который выполняется после всех таск, рестарт службы
    handlers:
      - name: Start nginx service
        become: true
        service:
          name: nginx
          state: restarted
    tasks:
 
# Добавление адресов серверов в /etc/hosts    
      - name: Add clickhouse addresses to /etc/hosts
        become: true
        lineinfile:
          dest: /etc/hosts
          regexp: '.*{{ item }}$'
          line: "{{ hostvars[item].ansible_host }} {{item}}"
          state: present
        when: hostvars[item].ansible_host is defined
        with_items: "{{ groups.clickhouse }}"

# Установка дополнительного репозитария
      - name: Install epel-release package
        become: true
        ansible.builtin.yum:
          name: epel-release
          state: present

# Обновление спискаа пакетов в репозитариях          
      - name: Update repositories
        become: true
        ansible.builtin.yum:
          name: '*'
          state: latest

# Установка nginx и архиватора unzip
      - name: Install Nginx and Unzip
        become: true
        ansible.builtin.yum:
          name:
            - nginx
            - unzip
          state: present

      - block:
# Получение zip дистрибутива Lighthouse     
          - name: Get lighthouse distrib
            ansible.builtin.get_url:
              url: "{{ lighthouse_distrib }}"
              dest: ./lighthouse.zip

# Создание директории для Lighthouse
          - name: Create directory
            become: true
            file:
              path: /usr/share/nginx
              state: directory
              force: yes

# Распаковка Lighthouse в рабочую папку
          - name: Unpack lighthouse archive
            become: true
            ansible.builtin.unarchive:
              src: /home/centos/lighthouse.zip
              dest: /usr/share/nginx
              remote_src: yes
              
# Создания файла конфигурации nginx              
          - name: Nginx configuration
            tags: nginx_config
            become: true
            ansible.builtin.copy:
              dest: /etc/nginx/conf.d/lighthouse.conf
              content: |
                {{ nginx_conf | to_nice_yaml(indent=2) }}

            notify: Start nginx service
````


 - Попробуйте запустить playbook на этом окружении с флагом --check.

<details><summary> Содержание вывода консоли </summary>

````
home@pc:~/DevOps обучение/devops-netology/Old_practice/Раздел_8/Practice_8.3/source$ ansible-playbook -i ./vm/hosts.yml all.yml --check

PLAY [Install Clickhouse] ************************************************************************************************************************************************************************

TASK [Gathering Facts] ***************************************************************************************************************************************************************************
 ok: [clickhouse-0]

TASK [Get clickhouse distrib (rpm noarch package)] ***********************************************************************************************************************************************
ok: [clickhouse-0] => (item=clickhouse-common-static)
ok: [clickhouse-0] => (item=clickhouse-server)
ok: [clickhouse-0] => (item=clickhouse-client)

TASK [Install clickhouse packages] ***************************************************************************************************************************************************************
ok: [clickhouse-0]

TASK [Flush handlers] ****************************************************************************************************************************************************************************

TASK [Create database] ***************************************************************************************************************************************************************************
skipping: [clickhouse-0]

PLAY [Install and configure Vector] **************************************************************************************************************************************************************

TASK [Gathering Facts] ***************************************************************************************************************************************************************************
ok: [vector-0]

TASK [Add clickhouse addresses to /etc/hosts] ****************************************************************************************************************************************************
ok: [vector-0] => (item=clickhouse-0)

TASK [Get vector distrib] ************************************************************************************************************************************************************************
ok: [vector-0]

TASK [Install vector package] ********************************************************************************************************************************************************************
ok: [vector-0]

TASK [Redefine vector config name] ***************************************************************************************************************************************************************
ok: [vector-0]

TASK [Create vector config] **********************************************************************************************************************************************************************
ok: [vector-0]

PLAY [Install Lighthouse] ************************************************************************************************************************************************************************

TASK [Gathering Facts] ***************************************************************************************************************************************************************************
ok: [lighthouse-0]

TASK [Add clickhouse addresses to /etc/hosts] ****************************************************************************************************************************************************
ok: [lighthouse-0] => (item=clickhouse-0)

TASK [Install epel-release package] **************************************************************************************************************************************************************
ok: [lighthouse-0]

TASK [Update repositories] ***********************************************************************************************************************************************************************
ok: [lighthouse-0]

TASK [Install Nginx and Unzip] *******************************************************************************************************************************************************************
ok: [lighthouse-0]

TASK [Get lighthouse distrib] ********************************************************************************************************************************************************************
ok: [lighthouse-0]

TASK [Create directory] **************************************************************************************************************************************************************************
ok: [lighthouse-0]

TASK [Unpack lighthouse archive] *****************************************************************************************************************************************************************
ok: [lighthouse-0]

TASK [Nginx configuration] ***********************************************************************************************************************************************************************
ok: [lighthouse-0]

PLAY RECAP ***************************************************************************************************************************************************************************************

clickhouse-0       : ok=3    changed=0    unreachable=0    failed=0    skipped=1    rescued=0   ignored=0    
lighthouse-0       : ok=9    changed=0    unreachable=0    failed=0    skipped=0    rescued=0   ignored=0    
vector-0           : ok=6    changed=0    unreachable=0    failed=0    skipped=0    rescued=0   ignored=0    
````

</details>


 - Запустите playbook на prod.yml окружении с флагом --diff. Убедитесь, что изменения на системе произведены.

<details><summary> Содержание вывода консоли </summary>

````
home@pc:~/DevOps обучение/devops-netology/Old_practice/Раздел_8/Practice_8.3/source$ ansible-playbook -i ./vm/hosts.yml all.yml

PLAY [Install Clickhouse] ************************************************************************************************************************************************************************

TASK [Gathering Facts] ***************************************************************************************************************************************************************************
ok: [clickhouse-0]

TASK [Get clickhouse distrib (rpm noarch package)] ***********************************************************************************************************************************************
ok: [clickhouse-0] => (item=clickhouse-common-static)
ok: [clickhouse-0] => (item=clickhouse-server)
ok: [clickhouse-0] => (item=clickhouse-client)

TASK [Install clickhouse packages] ***************************************************************************************************************************************************************
ok: [clickhouse-0]

TASK [Flush handlers] ****************************************************************************************************************************************************************************

TASK [Create database] ***************************************************************************************************************************************************************************
ok: [clickhouse-0]

PLAY [Install and configure Vector] **************************************************************************************************************************************************************

TASK [Gathering Facts] ***************************************************************************************************************************************************************************
ok: [vector-0]

TASK [Add clickhouse addresses to /etc/hosts] ****************************************************************************************************************************************************
ok: [vector-0] => (item=clickhouse-0)

TASK [Get vector distrib] ************************************************************************************************************************************************************************
ok: [vector-0]

TASK [Install vector package] ********************************************************************************************************************************************************************
ok: [vector-0]

TASK [Redefine vector config name] ***************************************************************************************************************************************************************
ok: [vector-0]

TASK [Create vector config] **********************************************************************************************************************************************************************
ok: [vector-0]

PLAY [Install Lighthouse] ************************************************************************************************************************************************************************

TASK [Gathering Facts] ***************************************************************************************************************************************************************************
ok: [lighthouse-0]

TASK [Add clickhouse addresses to /etc/hosts] ****************************************************************************************************************************************************
changed: [lighthouse-0] => (item=clickhouse-0)

TASK [Install epel-release package] **************************************************************************************************************************************************************
changed: [lighthouse-0]

TASK [Update repositories] ***********************************************************************************************************************************************************************
changed: [lighthouse-0]

TASK [Install Nginx and Unzip] *******************************************************************************************************************************************************************
changed: [lighthouse-0]

TASK [Get lighthouse distrib] ********************************************************************************************************************************************************************
changed: [lighthouse-0]

TASK [Create directory] **************************************************************************************************************************************************************************
ok: [lighthouse-0]

TASK [Unpack lighthouse archive] *****************************************************************************************************************************************************************
changed: [lighthouse-0]

TASK [Nginx configuration] ***********************************************************************************************************************************************************************
changed: [lighthouse-0]

RUNNING HANDLER [Start nginx service] ************************************************************************************************************************************************************
ok: [lighthouse-0]

PLAY RECAP ***************************************************************************************************************************************************************************************


 clickhouse-0      : ok=4        changed=0   unreachable=0   failed=0    skipped=0    rescued=0   ignored=0   
 lighthouse-0      : ok=9        changed=7   unreachable=0   failed=0    skipped=0    rescued=0   ignored=0  
 vector-0          : ok=6        changed=0   unreachable=0   failed=0    skipped=0    rescued=0   ignored=0   
````
</details>

 - Повторно запустите playbook с флагом --diff и убедитесь, что playbook идемпотентен.

<details><summary> Содержание вывода консоли </summary>

````
home@pc:~/DevOps обучение/devops-netology/Old_practice/Раздел_8/Practice_8.3/source$ ansible-playbook -i ./vm/hosts.yml all.yml --diff

PLAY [Install Clickhouse] ************************************************************************************************************************************************************************

TASK [Gathering Facts] ***************************************************************************************************************************************************************************
ok: [clickhouse-0]

TASK [Get clickhouse distrib (rpm noarch package)] ***********************************************************************************************************************************************
ok: [clickhouse-0] => (item=clickhouse-common-static)
ok: [clickhouse-0] => (item=clickhouse-server)
ok: [clickhouse-0] => (item=clickhouse-client)

TASK [Install clickhouse packages] ***************************************************************************************************************************************************************
ok: [clickhouse-0]

TASK [Flush handlers] ****************************************************************************************************************************************************************************

TASK [Create database] ***************************************************************************************************************************************************************************
ok: [clickhouse-0]

PLAY [Install and configure Vector] **************************************************************************************************************************************************************

TASK [Gathering Facts] ***************************************************************************************************************************************************************************
ok: [vector-0]

TASK [Add clickhouse addresses to /etc/hosts] ****************************************************************************************************************************************************
ok: [vector-0] => (item=clickhouse-0)

TASK [Get vector distrib] ************************************************************************************************************************************************************************
ok: [vector-0]

TASK [Install vector package] ********************************************************************************************************************************************************************
ok: [vector-0]

TASK [Redefine vector config name] ***************************************************************************************************************************************************************
ok: [vector-0]

TASK [Create vector config] **********************************************************************************************************************************************************************
ok: [vector-0]

PLAY [Install Lighthouse] ************************************************************************************************************************************************************************

TASK [Gathering Facts] ***************************************************************************************************************************************************************************
ok: [lighthouse-0]

TASK [Add clickhouse addresses to /etc/hosts] ****************************************************************************************************************************************************
ok: [lighthouse-0] => (item=clickhouse-0)

TASK [Install epel-release package] **************************************************************************************************************************************************************
ok: [lighthouse-0]

TASK [Update repositories] ***********************************************************************************************************************************************************************
ok: [lighthouse-0]

TASK [Install Nginx and Unzip] *******************************************************************************************************************************************************************
ok: [lighthouse-0]

TASK [Get lighthouse distrib] ********************************************************************************************************************************************************************
ok: [lighthouse-0]

TASK [Create directory] **************************************************************************************************************************************************************************
ok: [lighthouse-0]

TASK [Unpack lighthouse archive] *****************************************************************************************************************************************************************
ok: [lighthouse-0]

TASK [Nginx configuration] ***********************************************************************************************************************************************************************
ok: [lighthouse-0]

PLAY RECAP ***************************************************************************************************************************************************************************************

clickhouse-0               : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0       
lighthouse-0               : ok=9    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0       
vector-0                   : ok=6    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0       

````
</details>  
